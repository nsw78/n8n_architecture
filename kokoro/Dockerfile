# EstÃ¡gio 1: Builder - Instala dependÃªncias de sistema e Python
FROM python:3.10-slim AS builder

WORKDIR /app

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copia e instala dependÃªncias Python, otimizando o cache
COPY requirements.txt* .
RUN if [ -f requirements.txt ]; then \
      pip install --no-cache-dir -r requirements.txt; \
    else \
      pip install --no-cache-dir flask; \
    fi

# EstÃ¡gio 2: Runtime - Imagem final, menor e mais segura
FROM python:3.10-slim AS runtime

WORKDIR /app

# Cria um usuÃ¡rio nÃ£o-root para seguranÃ§a
RUN useradd --create-home --shell /bin/bash nonroot

# ðŸ”§ Instala curl para o HEALTHCHECK funcionar
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copia dependÃªncias de sistema e Python do estÃ¡gio builder
COPY --from=builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder /usr/bin/ffmpeg /usr/bin/ffmpeg

# Copia o cÃ³digo da aplicaÃ§Ã£o
COPY . .

# Cria um fallback se o cÃ³digo principal nÃ£o existir
RUN if [ ! -f app.py ] && [ ! -f main.py ]; then \
      printf "from flask import Flask, jsonify\napp = Flask(__name__)\n@app.route('/')\ndef index():\n    return 'Kokoro placeholder: coloque seu cÃ³digo em /kokoro'\n\n@app.route('/health')\ndef health():\n    return jsonify({'status': 'ok'})\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5002)\n" > /app/app.py; \
    fi

USER nonroot
EXPOSE 5002

# âœ… Adiciona o healthcheck diretamente aqui (opcional)
HEALTHCHECK CMD curl -f http://127.0.0.1:5002/health || exit 1

CMD ["sh", "-c", "if [ -f main.py ]; then python main.py; elif [ -f app.py ]; then python app.py; else sleep infinity; fi"]
