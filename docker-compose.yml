# =====================================================
# üöÄ STACK PRINCIPAL DE AUTOMA√á√ÉO
# Servi√ßos: n8n, MinIO, Baserow, Kokoro, Ollama e NCA Toolkit
# =====================================================

services:
  # ==========================================
  # üß† n8n - Plataforma de automa√ß√£o e IA
  # ==========================================
  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    user: "1000" # Garante que o cont√™iner execute com o usu√°rio 'node' e tenha permiss√£o no volume
    ports:
      - "${N8N_PORT:-5680}:5678"
    env_file:
      - .env
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - TZ=${TZ}
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-http://localhost:5680}
      # For√ßa o uso do banco de dados SQLite interno, ignorando vari√°veis do .env
      - DB_TYPE=sqlite
    volumes:
      - n8n_data:/home/node/.n8n
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5678/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    depends_on:
      - minio
      - baserow

  # ==========================================
  # üóÑÔ∏è MinIO - Armazenamento de objetos (S3)
  # ==========================================
  minio:
    image: minio/minio:RELEASE.2024-01-31T20-20-33Z
    restart: unless-stopped
    ports:
      - "${MINIO_PORT:-9005}:9000"
      - "${MINIO_CONSOLE_PORT:-9006}:9001"
    env_file:
      - .env
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_DOMAIN=${MINIO_DOMAIN:-localhost}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ==========================================
  # üíæ Banco de dados PostgreSQL para o Baserow
  # ==========================================
  baserow-db:
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_DB=baserow
      - POSTGRES_USER=baserow
      - POSTGRES_PASSWORD=baserow
    volumes:
      - baserow_db_data:/var/lib/postgresql/data

  # ==========================================
  # üßæ Baserow - Banco de dados visual (no-code)
  # ==========================================
  baserow:
    image: baserow/baserow:latest
    restart: unless-stopped
    ports:
      - "${BASEROW_PORT:-8081}:80"
    env_file:
      - .env
    environment:
      - BASEROW_PUBLIC_URL=${BASEROW_PUBLIC_URL:-http://localhost:8081}
      - TZ=${TZ}
      - DATABASE_HOST=baserow-db
      - DATABASE_NAME=baserow
      - DATABASE_USER=baserow
      - DATABASE_PASSWORD=baserow
      # For√ßa a desativa√ß√£o de qualquer configura√ß√£o externa do Redis vinda do .env
      - REDIS_HOST=
      - REDIS_PORT=
      - REDIS_USER=
      - REDIS_PASSWORD=
      - REDIS_URL=
    volumes:
      - baserow_app_data:/baserow/data
    healthcheck:
      test: ["CMD", "bash", "-c", "curl -f http://localhost:80/api/_health/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
    depends_on:
      - baserow-db

  # ==========================================
  # üîä Kokoro TTS - IA de voz (Text-to-Speech)
  # ==========================================
  kokoro:
    build:
      context: ./kokoro
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${KOKORO_PORT:-5002}:5002"
    env_file:
      - .env
    depends_on:
      - minio
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================
  # üß∞ NCA Toolkit - Ferramentas customizadas
  # ==========================================
  nca-toolkit:
    build:
      context: ./nca-toolkit
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${NCA_TOOLKIT_PORT:-8088}:8088"
    env_file:
      - .env
    environment:
      - MINIO_ENDPOINT=http://minio:9000 # Adicionado http://
      - BASEROW_ENDPOINT=http://baserow:80 # Baserow client espera a URL completa
      - KOKORO_ENDPOINT=http://kokoro:5002 # Kokoro client espera a URL completa
      - OLLAMA_API_URL=http://ollama:11434 # Ollama client espera a URL completa
      - NCA_TOOLKIT_KEY=${NCA_TOOLKIT_KEY}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - BASEROW_API_KEY=${BASEROW_API_KEY}
      - BASEROW_TABLE_ID=${BASEROW_TABLE_ID}
      - NCA_TOOLKIT_PORT=${NCA_TOOLKIT_PORT:-8088}
      - TZ=${TZ}
    volumes:
      - ./data:/app/data
    depends_on:
      - minio
      - baserow
      - kokoro
      - ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================
  # üß† Ollama - Servi√ßo de LLM
  # ==========================================
  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama

# ==========================================
# üíæ Volumes persistentes
# ==========================================
volumes:
  n8n_data:
  minio_data:
  baserow_db_data:  # Volume dedicado para o banco de dados do Baserow
  baserow_app_data: # Volume dedicado para os arquivos da aplica√ß√£o Baserow
  ollama_data:

# ==========================================
# üåê Rede padr√£o (bridge interna)
# ==========================================
networks:
  default:
    driver: bridge
