
###############################
# REDE PRINCIPAL DO PROJETO
###############################
networks:
  nca_network:
    driver: bridge

###############################
# DEFINIÇÃO DOS VOLUMES
###############################
volumes:
  ambiente-nca_postgres_data:
  ambiente-nca_minio_data:
  ambiente-nca_baserow_data:
  ambiente-nca_ollama_data:
  ambiente-nca_kokoro_data:

###############################
# SERVIÇOS DO AMBIENTE NCA
###############################
services:

  #########################################
  # 1️⃣ POSTGRES - BANCO DE DADOS PRINCIPAL
  #########################################
  postgres:
    image: postgres:15
    container_name: ambiente-nca-postgres
    restart: always
    environment:
      POSTGRES_USER: nca_user
      POSTGRES_PASSWORD: nca_pass
      POSTGRES_DB: nca_db
    volumes:
      - ambiente-nca_postgres_data:/var/lib/postgresql/data
    # A porta do Postgres não precisa ser exposta, pois a comunicação é interna na rede Docker.
    networks:
      - nca_network

  #########################################
  # 2️⃣ MINIO - ARMAZENAMENTO DE OBJETOS (S3)
  #########################################
  minio:
    image: minio/minio:latest
    container_name: ambiente-nca-minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password123
    volumes:
      - ambiente-nca_minio_data:/data
    ports:
      - "9005:9000"   # API S3 exposta na porta 9005 do host
      - "9006:9001"   # Console Web exposto na porta 9006 do host
    networks:
      - nca_network

  #########################################
  # 3️⃣ N8N - AUTOMAÇÃO E WORKFLOWS INTELIGENTES
  #########################################
  n8n:
    image: n8nio/n8n:latest
    container_name: ambiente-nca-n8n
    restart: always
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=nca_db
      - DB_POSTGRESDB_USER=nca_user
      - DB_POSTGRESDB_PASSWORD=nca_pass
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
    ports:
      - "5680:5678" # Mapeia a porta interna 5678 para a porta 5680 do host, evitando conflito.
    depends_on:
      - postgres
    networks:
      - nca_network

  #########################################
  # 4️⃣ NCA-TOOLKIT - SEU BACKEND / API FLASK
  #########################################
  nca-toolkit:
    build:
      context: ./nca-toolkit  # Aponta para a pasta correta
      dockerfile: Dockerfile      # O nome do arquivo dentro do contexto
    container_name: ambiente-nca-nca-toolkit
    restart: always
    environment:
      # Conexões com os outros serviços
      - MINIO_ENDPOINT=http://minio:9000
      - BASEROW_ENDPOINT=http://baserow:80
      - KOKORO_ENDPOINT=http://kokoro:5002
      - OLLAMA_API_URL=http://ollama:11434
      # Chaves e IDs (carregados do .env)
      - BASEROW_API_KEY=${BASEROW_API_KEY}
      - BASEROW_TABLE_ID=${BASEROW_TABLE_ID}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    ports:
      - "8088:8088"
    depends_on:
      - postgres
      - minio
      - baserow
      - ollama
      - kokoro
    networks:
      - nca_network

  #########################################
  # 5️⃣ BASEROW - BANCO DE DADOS NO-CODE
  #########################################
  baserow:
    image: baserow/baserow:latest
    container_name: ambiente-nca-baserow
    restart: always
    environment:
      - BASEROW_PUBLIC_URL=http://localhost:8081
      - DATABASE_HOST=postgres
      - DATABASE_NAME=nca_db
      - DATABASE_USER=nca_user
      - DATABASE_PASSWORD=nca_pass
    ports:
      - "8081:80"
    volumes:
      - ambiente-nca_baserow_data:/baserow/data
    depends_on:
      - postgres
    networks:
      - nca_network

  #########################################
  # 6️⃣ OLLAMA - SERVIÇO DE IA (LLM)
  #########################################
  ollama:
    image: ollama/ollama:latest
    container_name: ambiente-nca-ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ambiente-nca_ollama_data:/root/.ollama
    networks:
      - nca_network

  #########################################
  # 7️⃣ KOKORO - SERVIÇO DE TEXT-TO-SPEECH
  #########################################
  kokoro:
    build:
      context: ./kokoro
    container_name: ambiente-nca-kokoro
    restart: always
    ports:
      - "5002:5002"
    volumes:
      - ambiente-nca_kokoro_data:/app/models
    networks:
      - nca_network

  #########################################
  # 8️⃣ BACKUP - BACKUP AUTOMÁTICO DIÁRIO
  #########################################
  backup:
    image: alpine:latest
    container_name: ambiente-nca-backup
    restart: always
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        while true; do
          echo "Executando backup dos volumes...";
          # BACKUP DO POSTGRES
          tar czf /backup/postgres_backup_$$(date +%F_%H-%M-%S).tar.gz -C /data_postgres .;
          # BACKUP DO MINIO
          tar czf /backup/minio_backup_$$(date +%F_%H-%M-%S).tar.gz -C /data_minio .;
          echo "Backup concluído. Aguardando 24h...";
          sleep 86400;
        done
    volumes:
      - ambiente-nca_postgres_data:/data_postgres:ro
      - ambiente-nca_minio_data:/data_minio:ro
      - ./backup:/backup
    networks:
      - nca_network
