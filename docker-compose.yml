# =====================================================
# üöÄ STACK PRINCIPAL DE AUTOMA√á√ÉO (NCA TOOLKIT)
# Servi√ßos: n8n, MinIO, Baserow, Kokoro, Ollama e NCA Toolkit
# =====================================================

services:
  # ==========================================
  # üíæ PostgreSQL - Banco de dados
  # ==========================================
  postgres:
    image: postgres:15
    container_name: ambiente-nca_postgres_1
    restart: unless-stopped
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: StrongPass@2025
      POSTGRES_DB: main_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # üß† n8n - Plataforma de automa√ß√£o e IA
  # ==========================================
  n8n:
    image: n8nio/n8n:latest
    container_name: ambiente-nca_n8n_1
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5680}:5678"
    environment:
      TZ: ${TZ:-America/Sao_Paulo}
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-true}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD:-StrongPass@2025}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:-defaultEncryptionKey}
      N8N_HOST: 0.0.0.0
      N8N_PORT: 5678
      N8N_EDITOR_BASE_URL: ${N8N_EDITOR_BASE_URL:-http://localhost:5680}
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: main_db
      DB_POSTGRESDB_USER: admin
      DB_POSTGRESDB_PASSWORD: StrongPass@2025
      GENERIC_TIMEZONE: ${TZ:-America/Sao_Paulo}
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy
      baserow:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================
  # üóÑÔ∏è MinIO - Armazenamento de objetos S3
  # ==========================================
  minio:
    image: minio/minio:latest
    container_name: ambiente-nca_minio_1
    restart: unless-stopped
    ports:
      - "${MINIO_PORT:-9005}:9000"
      - "${MINIO_CONSOLE_PORT:-9006}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-StrongPass@2025}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:9000/minio/health/live || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================
  # üßæ Baserow - Banco de dados visual (no-code)
  # ==========================================
  baserow:
    image: baserow/baserow:latest
    container_name: ambiente-nca_baserow_1
    restart: unless-stopped
    ports:
      - "${BASEROW_PORT:-8081}:80"
    environment:
      BASEROW_PUBLIC_URL: ${BASEROW_PUBLIC_URL:-http://localhost:8081}
      TZ: ${TZ:-America/Sao_Paulo}
      DATABASE_HOST: postgres
      DATABASE_NAME: main_db
      DATABASE_USER: admin
      DATABASE_PASSWORD: StrongPass@2025
    volumes:
      - baserow_app_data:/baserow/data
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost/api/_health/ || exit 1"]
      interval: 60s
      timeout: 20s
      retries: 10

  # ==========================================
  # üîä Kokoro TTS - IA de voz (Text-to-Speech)
  # ==========================================
  kokoro:
    build:
      context: ./kokoro
      dockerfile: Dockerfile
    container_name: ambiente-nca_kokoro_1
    restart: unless-stopped
    ports:
      - "${KOKORO_PORT:-5002}:5002"
    env_file:
      - .env
    depends_on:
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:5002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================
  # üß∞ NCA Toolkit - Ferramentas personalizadas
  # ==========================================
  nca-toolkit:
    build:
      context: ./nca-toolkit
      dockerfile: Dockerfile
    container_name: ambiente-nca_nca-toolkit_1
    restart: unless-stopped
    ports:
      - "${NCA_TOOLKIT_PORT:-8088}:8088"
    env_file:
      - .env
    environment:
      TZ: ${TZ:-America/Sao_Paulo}
      NCA_TOOLKIT_KEY: ${NCA_TOOLKIT_KEY:-default-key}
      MINIO_ENDPOINT: http://minio:9000
      BASEROW_ENDPOINT: http://baserow:80
      KOKORO_ENDPOINT: http://kokoro:5002
      OLLAMA_API_URL: http://ollama:11434
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-StrongPass@2025}
      BASEROW_API_KEY: ${BASEROW_API_KEY:-default-api}
      BASEROW_TABLE_ID: ${BASEROW_TABLE_ID:-1}
    volumes:
      - ./data:/app/data
    depends_on:
      baserow:
        condition: service_healthy
      minio:
        condition: service_healthy
      kokoro:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8088 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================
  # üß† Ollama - Modelos de linguagem (LLM)
  # ==========================================
  ollama:
    image: ollama/ollama:latest
    container_name: ambiente-nca_ollama_1
    restart: unless-stopped
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_data:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:11434/api/tags || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

# ==========================================
# üíæ Volumes persistentes
# ==========================================
volumes:
  n8n_data:
  minio_data:
  baserow_app_data:
  postgres_data:
  ollama_data:

# ==========================================
# üåê Rede padr√£o (bridge)
# ==========================================
networks:
  default:
    driver: bridge
