services:

  # ============================================================
  # ğŸ—ƒï¸ POSTGRES (Base para o Baserow)
  # ============================================================
  postgres:
    image: postgres:15
    container_name: ambiente-nca-postgres
    restart: always
    environment:
      POSTGRES_USER: baserow
      POSTGRES_PASSWORD: baserow
      POSTGRES_DB: baserow
      TZ: ${TZ}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - nca_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U baserow"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # ğŸ“Š BASEROW
  # ============================================================
  baserow:
    image: baserow/baserow:1.25.2
    container_name: ambiente-nca-baserow
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      BASEROW_PUBLIC_URL: ${BASEROW_PUBLIC_URL}
      DATABASE_USER: baserow
      DATABASE_PASSWORD: baserow
      DATABASE_NAME: baserow
      DATABASE_HOST: postgres
      BASEROW_API_KEY: ${BASEROW_API_KEY}
      TZ: ${TZ}
    ports:
      - "${BASEROW_PORT}:80"
    volumes:
      - ./data/baserow/data:/baserow/data      # â† ESSENCIAL
      - ./data/baserow/media:/baserow/media
      - ./data/baserow/backups:/baserow/backups
    networks:
      - nca_network

  # ============================================================
  # ğŸ§Š MINIO
  # ============================================================
  minio:
    image: minio/minio:latest
    container_name: ambiente-nca-minio
    command: server /data --console-address ":${MINIO_CONSOLE_PORT}"
    restart: always
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "${MINIO_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:9006"
    volumes:
      - ./data/minio:/data
    networks:
      - nca_network

  # ============================================================
  # ğŸ”Š KOKORO TTS
  # ============================================================
  kokoro:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:latest
    container_name: ambiente-nca-kokoro
    restart: always
    ports:
      - "${KOKORO_PORT}:5002"
    networks:
      - nca_network

  # ============================================================
  # ğŸ¤– OLLAMA
  # ============================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ambiente-nca-ollama
    restart: always
    ports:
      - "${OLLAMA_PORT}:11434"
    volumes:
      - ./data/ollama:/root/.ollama
    networks:
      - nca_network

  # ============================================================
  # âš™ï¸ n8n (AutomaÃ§Ã£o)
  # ============================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: ambiente-nca-n8n
    restart: always
    environment:
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      WEBHOOK_URL: ${WEBHOOK_URL}
      N8N_EDITOR_BASE_URL: ${N8N_EDITOR_BASE_URL}
      TZ: ${TZ}
    ports:
      - "${N8N_PORT}:5678"
    volumes:
      - ./data/n8n:/home/node/.n8n
    networks:
      - nca_network

  # ============================================================
  # ğŸ§° NCA TOOLKIT (Python)
  # ============================================================
  nca-toolkit:
    build:
      context: ./nca-toolkit
    container_name: ambiente-nca-toolkit
    restart: always
    environment:
      NCA_TOOLKIT_KEY: ${NCA_TOOLKIT_KEY}
      OLLAMA_API_URL: http://ollama:11434
      BASEROW_API_KEY: ${BASEROW_API_KEY}
      BASEROW_TABLE_ID: ${BASEROW_TABLE_ID}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      TZ: ${TZ}
    ports:
      - "${NCA_TOOLKIT_PORT}:8088"
    networks:
      - nca_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # ğŸ”„ BACKUP CRON
  # ============================================================
  backup:
    image: alpine:latest
    container_name: ambiente-nca-backup
    restart: always
    volumes:
      - ./data:/data
      - ./backup:/backup
    entrypoint: >
      sh -c 'echo "0 3 * * * tar -czf /backup/nca-backup-$$(date +\%Y\%m\%d).tar.gz /data" | crontab - && crond -f'
    networks:
      - nca_network

# ============================================================
# ğŸŒ NETWORK
# ============================================================
networks:
  nca_network:
    driver: bridge
